<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../bower_components/recorder-js/recorder.js"></script>

<dom-module id="audio-recorder">
  <template>
    <style>
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .visualization {
        height: 50px;
        background: #f3f3f3;
      }
      audio {
        display: block;
        margin-top: 10px;
      }
    </style>
    <div>
      <div class="controls">
        <button on-tap="_startRecording">Start</button>
        <button on-tap="_stopRecording" disabled$="[[!isRecording]]">Stop</button>
        <button on-tap="_discardRecording" disabled$="[[!recordedBlob]]">Delete</button>
        <button on-tap="_saveRecording" disabled$="[[!recordedBlob]]">Save</button>
      </div>
      <div class="visualization" id="visualization"></div>
      <audio controls hidden$="[[!recordedBlob]]" src$="[[audioUrl]]"></audio>
    </div>
  </template>

  <script>
    Polymer({
      is: 'audio-recorder',

      properties: {
        isRecording: {
          type: Boolean,
          value: false,
        },
        recordedBlob: {
          type: Object,
          value: null,
        },
        audioUrl: {
          type: String,
          value: '',
        },
      },

      ready: function () {
        this._initRecorder();
      },

      _initRecorder: function () {
        // Initialize AudioContext and Recorder
        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        this.recorder = new Recorder(this.audioContext);
      },

      _startRecording: function () {
        // Request microphone access and start recording
        navigator.mediaDevices
          .getUserMedia({ audio: true })
          .then((stream) => {
            this.recorder.init(stream);
            return this.recorder.start();
          })
          .then(() => {
            this.isRecording = true;
          })
          .catch((err) => console.error('Error starting recording:', err));
      },

      _stopRecording: function () {
        // Stop recording and generate the audio blob
        this.recorder
          .stop()
          .then(({ blob }) => {
            this.recordedBlob = blob;
            this.audioUrl = URL.createObjectURL(blob);
            this.isRecording = false;
          })
          .catch((err) => console.error('Error stopping recording:', err));
      },

      _discardRecording: function () {
        // Discard the recording
        this.recordedBlob = null;
        this.audioUrl = '';
      },

      _saveRecording: function () {
        // Save the recording as a .wav file
        Recorder.download(this.recordedBlob, 'my-audio-file.wav');
      },
    });
  </script>
</dom-module>
